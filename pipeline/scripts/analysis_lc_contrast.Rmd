---
title: "Exploratory Analysis for MoTR Reading Data"
output: html_notebook
---

```{r}
shhh <- suppressPackageStartupMessages # It's a library, so shhh!

shhh(library( mgcv ))
shhh(library(dplyr))
shhh(library(ggplot2))
shhh(library(lme4))
shhh(library(tidymv))
shhh(library(gamlss))
shhh(library(gsubfn))
shhh(library(lmerTest))
shhh(library(tidyverse))
shhh(library(boot))
shhh(library(rsample))
shhh(library(plotrix))
shhh(library(ggrepel))
shhh(library(mgcv))

#library(jglmm)
#options(JULIA_HOME = "/Applications/Julia-1.8.app/Contents/Resources/julia/bin/")
#jglmm_setup()

theme_set(theme_bw())
options(digits=4)
options(scipen=999)
set.seed(444)
pipe_message = function(.data, status) {message(status); .data}

```


# Read in MoTR Data

```{r}

rate = 160

file_prefix = paste0("/Users/ethan/Desktop/motr_lc_", as.character(rate),"/")
fnames = list.files(path=file_prefix)

# Read in the data
df = data.frame()
for (f in fnames) {
  temp = read.csv(paste0(file_prefix, "/", f)) %>%
    mutate(subj = str_remove(f, "_reading_measures.csv")) %>%
    rename(go_past_time = 15)
  df = rbind(df, temp)
}

filter_df = df %>%
  group_by(para_nr, subj) %>%
    summarise(correct = if_else(unique(correctness) == 1, 1, 0)) %>%
  ungroup() %>%
  drop_na() %>%
  group_by(subj) %>%
    summarise(p_correct = mean(correct)) %>%
  ungroup() %>%
  mutate(p_correct = round(p_correct, digits = 2))

filter_df %>%
  filter(p_correct < 0.8)

raw_df = df %>%
  mutate(subj = str_remove(subj, "reader_")) %>%
  mutate(subj = as.integer(subj)) %>%
  # Filter out participants who were bots
  filter(! subj %in% c(118, 119, 120, 107, 103, 130, 6, 19) ) %>%
  # See below for filtering out reading measures that are super long
  dplyr::select(expr_id, cond_id, para_nr, word, word_nr, first_duration, total_duration, gaze_duration, go_past_time, FPReg, subj, sent_rg_id, sent_rg)

raw_df
```

```{r}

motr_df = raw_df %>%
  gather(metric, value, 6:10) %>%
  mutate(condition = case_when(
    cond_id == 1 ~ "high", # Really, "no-comma"
    cond_id == 2 ~ "low", # Really, "comma"
    cond_id == 3 ~ "high",
    cond_id == 4 ~ "low",
    cond_id == 5 ~ "high",
    cond_id == 6 ~ "low",
    cond_id == 8 ~ "filler"
  )) %>%
  mutate(experiment = case_when(
    cond_id %in% c(1, 2) ~ "Coordination",
    cond_id %in% c(3, 4) ~ "Adverb",
    cond_id %in% c(5, 6) ~ "Relative Clause",
    cond_id %in% c(8) ~ "Filler"
  )) %>%
  rename(item_id = para_nr) %>%
  dplyr::select(-cond_id, -expr_id) %>%
  filter(experiment != "Filler")

```

```{r}

motr_aligned_df = motr_df %>%
  filter(! (item_id == 45 & experiment == "Coordination")) %>% #Filtering out a case of off-by-one indexing
  mutate(crit = case_when(
    experiment == "Coordination" & word == "and" ~ word_nr,
    experiment == "Relative Clause" & word %in% c("himself", "herself") ~ word_nr,
    experiment == "Adverb" & word %in% c("last", "next", "yesterday", "tomorrow", "tomorrow,", "yesterday,") ~ word_nr,
  )) %>%
  group_by(condition, item_id) %>%
    mutate(crit = unique(crit)[2]) %>%
  ungroup() %>%
  mutate(crit = if_else(experiment == "Coordination", as.integer(crit + 3), as.integer(crit))) %>%
  mutate(word_nr = as.character(word_nr - crit)) %>%
  
  # Filter out sentences where the participant focuses on less than 1/5 of the total words, i.e. where they are skimming
  group_by(item_id, subj, metric, condition, experiment) %>%
    mutate(fixed = if_else(value > 0, 1, 0),
           n_fixed = sum(fixed),
           n_words = n()) %>%
  ungroup() %>%
  mutate(fix_threshold = n_fixed > (n_words / 3)) %>%
  mutate(skimming = if_else(metric != "FPReg" & fix_threshold == F,T, F)) %>%
  
  # Filter out words with a reading-time of zero
  #mutate(zero = if_else(metric != "FPReg" & value == 0,T, F)) %>%
  #filter(zero == F) %>%
  
  #Filter out words that are more than 4 SDs away from the mean of their reading time
  group_by(metric) %>%
    mutate(outlier = value > (mean(value) + 4 * sd(value))) %>%
  ungroup() %>%
  mutate(outlier_discard = if_else(metric %in% c("first_duration", "first_fixation", "total_fixation", "go_past_time") & outlier == T, F, T)) %>%
  filter(outlier_discard == T) %>%
  drop_na() %>%
  
  # Finally, filter out all the sentences that were skimmed
  filter(skimming == F) %>%
  dplyr::select(-fixed, -n_fixed, -n_words, -fix_threshold, -skimming, -outlier)
  

motr_aligned_df %>%
  arrange(experiment, condition, subj, metric, item_id, word_nr)
```
```{r}
motr_aligned_df %>%
  group_by(item_id, experiment) %>%
  mutate(subj = as.character(subj)) %>%
    summarise( n_subj = length(unique(subj)))

```

## Comparison Between Conditions

```{r}
  
# Average across subjects -- differences between conditions
motr_comp_agg_df = motr_aligned_df %>%
  group_by(experiment, condition, item_id, word_nr, metric) %>%
    summarise(value = mean(value)) %>%
  ungroup() %>%
  spread(condition, value) %>%
  mutate(diff = high - low) %>%
  drop_na() %>%
  group_by(experiment, word_nr, metric) %>%
    summarise( m = mean(diff),
               sd = std.error(diff),
               upper = m + 1.96 * sd,
               lower = m - 1.98 * sd,
               n = n()) %>%
  ungroup()

motr_comp_agg_df

```


## Stats!

```{r, eval=FALSE}
library(brms)

motr_stats_df = data.frame()

for(exp in c("Coordination", "Relative Clause", "Adverb")) {
  print(paste0("Stats for: ", exp))
  for(m in c("first_duration", "gaze_duration", "go_past_time", "total_duration", "FPReg")){
    for(i in 0:3) {
      
      temp_df = motr_aligned_df %>% filter(metric == m, experiment == exp, word_nr == i) %>%
        mutate(item_id = as.factor(item_id), subj = as.factor(subj), condition = if_else(condition == "high", 1, 0))
      if (m == "FPReg") {
        model = glmer(value ~ condition + (condition || subj) + (condition || item_id), data = temp_df, family = "binomial")
        pval = coef(summary(model))[8]
      } else {
        temp_df = temp_df %>% mutate(value = scale(value)) #scale real-valued numbers for lmer
        model = lmer(value ~ condition + (condition || subj) + (condition || item_id), data = temp_df)
        pval = coef(summary(model))[10]
      }
      result_df = data.frame(experiment = exp, word_nr = i, metric = m, pval = pval)
      motr_stats_df = rbind(motr_stats_df, result_df)
    }
  }
}

```

```{r}

motr_plotting_df = merge(motr_comp_agg_df, motr_stats_df, all=T, by = c("word_nr", "metric", "experiment")) %>%
#motr_plotting_df = motr_comp_agg_df %>%
  filter(word_nr >= 0, word_nr <= 3) %>%
  group_by(metric, experiment) %>%
    mutate(max_y = max(upper),
           min_y = min(lower)) %>%
  ungroup() %>%
  mutate(sig_y = max_y + max_y / 6,
         top_y = max_y + max_y / 4)

```


```{r}

motr_plotting_df %>%
  #mutate(pval = 1) %>%
  mutate(word_nr = as.integer(word_nr)) %>%
  mutate(sig = if_else(pval >= 0.05, "", as.character(round(pval, 3 )))) %>%
  mutate(sig = if_else(pval < 0.001, "< 0.001", sig)) %>%
  mutate(metric = factor(metric, levels = c("first_duration", "gaze_duration", "go_past_time", "total_duration", "FPReg"),
                         labels = c("First Duration", "Gaze Duration", "Go Past Time", "Total Duration", "Regression Prob"))) %>%
  ggplot(aes(x = word_nr, y = m)) +
    #geom_rect(aes(xmin = -0.5, xmax = 2.5, ymin=min_y, ymax=max_y), fill=alpha("white", 0), color = "#45ef70", linetype = "dotted") +
    geom_hline(yintercept = 0, color = "blue") +
    geom_point() +
    geom_errorbar(aes(ymax = upper, ymin = lower), width = 0.1) +
    geom_line() +
    geom_text(aes(label = sig, y = sig_y), color = "black", size = 2) +
    geom_text(aes(label = " ", y = top_y), color = "black") +
  ylab("Difference in RTs (ms) Between Conditions") +
  xlab(" ") +
  coord_cartesian(xlim = c(-0.25, 3.25)) +
  #scale_x_continuous(breaks=-3:4, labels=c("and", "the", "designer", "took", "a", "bow", "after", "the")) +
  #facet_grid(metric~experiment, scales = "free_y") +
  facet_wrap(experiment~metric, scales="free_y", nrow = 3)
  theme(
    legend.position = "none"
  )

ggsave(paste0("../visualization/fix_threshold/contrast_all_", rate, ".pdf"), device="pdf", width = 8, height = 5)

```

## Eyetracking / MoTR Direct Comparison

```{r}

motr_region_df = motr_aligned_df %>%
  group_by(item_id, subj, sent_rg_id, sent_rg, metric, condition, experiment) %>%
    summarise(value = mean(value)) %>%
  ungroup %>%
  group_by(item_id, sent_rg_id, sent_rg, metric, condition, experiment) %>%
    summarise(value = mean(value)) %>%
  ungroup() %>%
  spread(condition, value) %>%
  mutate(diff = high - low) %>%
  group_by(sent_rg_id, sent_rg, metric, experiment) %>%
    summarise(m = mean(diff),
              std = std.error(diff),
              upper = m + 1.96 * std,
              lower = m - 1.96 * std) %>%
  ungroup() %>%
  mutate(measure = "MoTR")

motr_region_df

```
```{r}

eyetr_region_df = read.csv("/Users/ethan/Desktop/lc_eyetr_cleaned.csv") %>%
  mutate(Region_Order = Region_Order - 1) %>%
  mutate(Condition = if_else(Condition == "Hight attachment", "High attachment", Condition)) %>%
  mutate(Condition = if_else(Condition == "Ambiguous", "High attachment", Condition),
         Condition = if_else(Condition == "Unambiguous", "Low attachment", Condition)) %>%
  spread(Condition, Value) %>%
  mutate(m = `High attachment` - `Low attachment`) %>%
  
  rename(experiment = Study, metric = Metric, sent_rg_id = Region_Order) %>%
  dplyr::select(-`High attachment`, -`Low attachment`, -Region) %>%
  mutate(sent_rg = "",
         std = 0,
         upper = m,
         lower = m,
         measure = "Eye Tracking")

eyetr_region_df

```
```{r}

region_merged_df = rbind(motr_region_df, eyetr_region_df)

```



```{r}
  
region_merged_df %>%
 mutate(metric = factor(metric, levels = c("first_duration", "gaze_duration", "go_past_time", "total_duration", "FPReg"),
                         labels = c("First Duration", "Gaze Duration", "Go Past Time", "Total Duration", "Regression Prob"))) %>% 
  
  mutate(measure = factor(measure, levels = c("MoTR", "Eye Tracking"))) %>%  
  ggplot(aes(x = sent_rg_id,  y = m, color = measure, linetype = measure)) +
    geom_hline(yintercept = 0, color = "blue") +
    geom_point() +
    geom_line() +
    geom_errorbar(aes(ymax = upper, ymin=lower), width = 0) +
    geom_text(aes(x = 0, y = if_else(metric == "Regression Prob", 0.07, 200), label="")) +
  ylab("Difference in RTs (ms) Between Conditions") +
  xlab("Sentence Region") +
  scale_color_manual(values = c("#000000", "#2eccc1")) +
  #coord_cartesian(xlim = c(-0.25, 2.25), ylim = c(-120, 130)) +
  
  facet_wrap(experiment~metric, scales = "free_y", nrow = 3) + 
  theme(
    legend.position = "bottom"
  )
  
ggsave("../visualization/paper/attach_160.pdf", device="pdf", width = 8, height = 5)

```

```{r}

region_comp_df = merge(motr_region_df, eyetr_region_df, by=c("experiment", "metric", "sent_rg_id"))

cor.test(region_comp_df$m.x, region_comp_df$m.y)

region_comp_df %>%
  ggplot(aes(x = m.x, y=m.y)) +
    geom_point() +
    stat_smooth(, method = "lm")

```


